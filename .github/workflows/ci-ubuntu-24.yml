name: CI (Ubuntu 24.04)

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    strategy:
      matrix:
        with_extensions: [false, true]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            openjdk-11-jre-headless \
            libpq-dev \
            build-essential \
            python3-dev \
            python3-pip \
            python3-six \
            libssl-dev \
            netcat-openbsd \
            python3-bs4 \
            git \
            gperf \
            libmemcached-dev \
            libsnappy-dev \
            memcached

      - name: Install and start PostgreSQL
        run: |
          sudo apt-get install -y postgresql postgresql-contrib
          sudo service postgresql start
          sudo -u postgres psql -c "CREATE USER reddit WITH PASSWORD 'password';"
          sudo -u postgres psql -c "CREATE DATABASE reddit OWNER reddit;"

      - name: Start Cassandra (docker)
        run: |
          docker run -d --name reddit_cassandra -p 9042:9042 cassandra:4.1.10
          ready=1
          for i in $(seq 1 300); do
            if docker exec reddit_cassandra cqlsh -e "describe keyspaces" >/dev/null 2>&1; then
              echo 'cassandra up'
              ready=0
              break
            fi
            sleep 2
          done
          if [ "$ready" -ne 0 ]; then
            echo 'timed out waiting for cassandra'
            docker logs reddit_cassandra || true
            docker rm -f reddit_cassandra || true
            exit 2
          fi
          docker exec reddit_cassandra cqlsh -e "CREATE KEYSPACE IF NOT EXISTS reddit WITH replication = {'class':'SimpleStrategy','replication_factor':'1'};"

      - name: Install Python dependencies (common)
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install pyramid pyramid-mako cassandra-driver simplejson Paste PasteDeploy Pylons pytest pylibmc

      - name: Start memcached
        run: |
          sudo service memcached start

      - name: Install project (without extensions)
        if: matrix.with_extensions == false
        run: |
          # install editable without forcing build of C extensions
          pip install -e r2/ --no-build-isolation

      - name: Build and install with C extensions
        if: matrix.with_extensions == true
        run: |
          python -m pip install --upgrade pip setuptools wheel cython
          pip install -e r2/

      - name: Verify r2 package installation
        run: |
          python -c "import r2; print('r2 loaded from:', r2.__file__)"
          python -c "import r2.lib.db.sorts as s; print('epoch_seconds present:', hasattr(s,'epoch_seconds'))"
          python -c "from r2.r2.lib import loid; print('loid OK:', len(loid.LOID_CHARSPACE))"


      - name: Run unit tests (r2)
        env:
          DATABASE_URL: "postgresql://reddit:password@127.0.0.1/reddit"
        run: |
          python -m pytest r2/r2/tests/functional/controller/del_msg_test.py -v -s --tb=long --maxfail=5 | tee pytest-output.log

      - name: Print last 100 lines of pytest output
        if: always()
        run: |
          tail -n 100 pytest-output.log || true
          for f in r2/r2/tests/**/test*.log .pytest_cache/v/cache/lastfailed; do
            if [ -f "$f" ]; then
              echo "--- $f (last 40 lines) ---"; tail -n 40 "$f"; fi; done


      - name: Archive test logs and output
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            cassandra.out
            r2/r2/tests/**/test*.log
            pytest-output.log
            .pytest_cache/
