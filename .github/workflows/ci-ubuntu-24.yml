name: CI (Ubuntu 24.04)

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y wget openjdk-11-jre-headless libpq-dev build-essential python3-dev python3-pip python3-six libssl-dev netcat-openbsd

      - name: Install and start PostgreSQL
        run: |
          sudo apt-get install -y postgresql postgresql-contrib
          sudo service postgresql start
          sudo -u postgres psql -c "CREATE USER reddit WITH PASSWORD 'reddit';"
          sudo -u postgres psql -c "CREATE DATABASE reddit OWNER reddit;"

      - name: Start Cassandra (docker)
        run: |
          # Run Cassandra in Docker for consistent startup and dependencies
          docker run -d --name reddit_cassandra -p 9042:9042 cassandra:4.1.10
          # wait for CQL port
          for i in $(seq 1 180); do
            nc -z 127.0.0.1 9042 && { echo 'cassandra up'; break; } || sleep 1
          done
          if ! nc -z 127.0.0.1 9042; then
            echo 'timed out waiting for cassandra'
            docker logs reddit_cassandra || true
            docker rm -f reddit_cassandra || true
            exit 2
          fi
          # create keyspace via docker exec cqlsh
          docker exec reddit_cassandra cqlsh 127.0.0.1 9042 -e "CREATE KEYSPACE IF NOT EXISTS reddit WITH replication = {'class':'SimpleStrategy','replication_factor':'1'};"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          pip install -e r2/
          pip install pytest

      - name: Bootstrap DBs (create SQL tables & Cassandra CFs)
        run: |
          python tools/bootstrap_db.py --ini r2/example.ini

      - name: Run unit tests (r2)
        env:
          DATABASE_URL: "postgresql://reddit:reddit@127.0.0.1/reddit"
        run: |
          python -m pytest r2/r2/tests -q

      - name: Archive test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            cassandra.out
            r2/r2/tests/**/test*.log
