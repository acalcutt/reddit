name: CI (Ubuntu 24.04)

on:
  push:
  pull_request:

jobs:
  test:
    runs-on: ubuntu-24.04
    timeout-minutes: 120
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'

      - name: Install system packages
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            wget \
            openjdk-11-jre-headless \
            libpq-dev \
            build-essential \
            python3-dev \
            python3-pip \
            python3-six \
            libssl-dev \
            netcat-openbsd \
            python3-bs4 \
            git \
            gperf \
            libmemcached-dev \
            libsnappy-dev

      - name: Install and start PostgreSQL
        run: |
          sudo apt-get install -y postgresql postgresql-contrib
          sudo service postgresql start
          sudo -u postgres psql -c "CREATE USER reddit WITH PASSWORD 'reddit';"
          sudo -u postgres psql -c "CREATE DATABASE reddit OWNER reddit;"

      # Uncomment to enable Solr for search integration tests
      # - name: Start Solr (docker)
      #   run: |
      #     docker run -d --name reddit_solr -p 8983:8983 solr:9
      #     # Wait for Solr to be ready
      #     for i in $(seq 1 60); do
      #       if curl -s http://localhost:8983/solr/admin/cores >/dev/null 2>&1; then
      #         echo 'solr up'
      #         break
      #       fi
      #       sleep 2
      #     done
      #     # Create cores for reddit
      #     docker exec reddit_solr solr create_core -c reddit
      #     docker exec reddit_solr solr create_core -c reddit_subreddits

      - name: Start Cassandra (docker)
        run: |
          # Run Cassandra in Docker for consistent startup and dependencies
          docker run -d --name reddit_cassandra -p 9042:9042 cassandra:4.1.10
          # wait for CQL readiness by trying cqlsh inside the container
          ready=1
          for i in $(seq 1 300); do
            if docker exec reddit_cassandra cqlsh -e "describe keyspaces" >/dev/null 2>&1; then
              echo 'cassandra up'
              ready=0
              break
            fi
            sleep 2
          done
          if [ "$ready" -ne 0 ]; then
            echo 'timed out waiting for cassandra'
            docker logs reddit_cassandra || true
            docker rm -f reddit_cassandra || true
            exit 2
          fi
          # create keyspace via docker exec cqlsh
          docker exec reddit_cassandra cqlsh -e "CREATE KEYSPACE IF NOT EXISTS reddit WITH replication = {'class':'SimpleStrategy','replication_factor':'1'};"

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip setuptools wheel
          # install Pyramid and Mako, DataStax Cassandra driver and other runtime deps
          pip install pyramid pyramid-mako
          pip install cassandra-driver
          # ensure simplejson is available (needed by the project)
          pip install simplejson
          # ensure paste and paste-deploy are available for loadwsgi
          pip install Paste PasteDeploy
          pip install -e r2/ --no-build-isolation
          pip install pytest

      - name: Verify r2 package installation
        run: |
          python -c "import r2; print('r2 loaded from:', r2.__file__); print('make_app exists:', hasattr(r2, 'make_app'))"
          pip show r2

      - name: Bootstrap DBs (create SQL tables & Cassandra CFs)
        run: |
          python tools/bootstrap_db.py --ini r2/example.ini

      - name: Run unit tests (r2)
        env:
          DATABASE_URL: "postgresql://reddit:reddit@127.0.0.1/reddit"
        run: |
          python -m pytest r2/r2/tests -q

      - name: Archive test logs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-logs
          path: |
            cassandra.out
            r2/r2/tests/**/test*.log
